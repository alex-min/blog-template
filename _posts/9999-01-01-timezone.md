---
title: Managing browser timezones to display dates with Phoenix Live View
description: 
author: alex-min
image: /images/phoenix-scroll.png
tags:
  - elixir
  - phoenix
---
I'm currently building a web version of my personal finance application, for that, I've chosen to use [Phoenix Live View](https://github.com/phoenixframework/phoenix_live_view), it's the perfect tech for my use case.

In this finance web application, you do have a lot of dates to display including when you actually spent the money. Users (including myself) can also travel so the dates needs to be reflected according to the browser timezone.

There's a simple way to get the timezone in the browser:

```javascript
new Date().getTimezoneOffset(); // returns the timezone offset in minutes
```

So here are the main things we need to do:
  - Send the browser timezone to the Live View
  - Store the timezone in the session. This is needed for the server side rendering since we also want to display the right date even on the server side before the live view mounts. If we don't do this, we user is going to see the wrong date first and then the view will be re-rendered properly, this isn't a great UI and will look janky.
  - Retreive the timezone either from the Live socket parameters or the session on the server side rendering. 


Luckily for us, there's a simple way to send parameters on the initialisation of the Live Socket:

```javascript
let liveSocket = new LiveSocket("/live", Socket, {
    params: {
        timezone: - (new Date().getTimezoneOffset() / 60)
    }
})
```

That's as simple as that! This enables us to receive the timezone when the live view is connected, ```Phoenix.LiveView.get_connect_params/1``` can then be used to retreive that data if the socket is connected.

The first part being completed, we need to create a small controller which stores the timezone into the session:

```elixir
defmodule MavioWeb.SessionSetTimezoneController do
  use MavioWeb, :controller

  def set(conn, %{"timezone" => timezone}) when is_number(timezone) do
    conn |> put_session(:timezone, timezone) |> json(%{})
  end
end
```

On the first page load, we need to call this controller, for that a small bit of Javascript is needed:

```javascript
export default function sendTimezoneToServer() {
    const timezone = - (new Date().getTimezoneOffset() / 60);
    let csrfToken = document.querySelector("meta[name='csrf-token']").getAttribute("content")


    if (typeof window.localStorage != 'undefined') {
        try {
            // if we sent the timezone already or the timezone changed since last time we sent
            if (!localStorage["timezone"] || localStorage["timezone"].toString() != timezone.toString()) {
                var xhr = new XMLHttpRequest();
                xhr.open("POST", '/api/session/set-timezone', true);
                xhr.setRequestHeader("Content-Type", "application/json");
                xhr.setRequestHeader("x-csrf-token", csrfToken);
                xhr.onreadystatechange = function () {
                    if (this.readyState === XMLHttpRequest.DONE && this.status === 200) {
                        localStorage['timezone'] = timezone.toString();
                    }
                };
                xhr.send(`{"timezone": ${timezone}}`);
            }
        } catch (e) { }
    }
}
```

I'm using XMLHttpRequest since I also need to support older browsers but you might want to use ```window.fetch``` or Axios which have much nicer apis.


```elixir
  def get_timezone(socket, session) do
    if Phoenix.LiveView.connected?(socket) do
      case Phoenix.LiveView.get_connect_params(socket) do
        %{"timezone" => timezone} -> timezone
        _ -> session["timezone"] || 0
      end
    else
      session["timezone"] || 0
    end
  end
```



```javascript
export default function sendTimezoneToServer() {
    const timezone = - (new Date().getTimezoneOffset() / 60);
    let csrfToken = document.querySelector("meta[name='csrf-token']").getAttribute("content")


    if (typeof window.localStorage != 'undefined') {
        try {
            if (!localStorage["timezone"] || localStorage["timezone"].toString() != timezone.toString()) {
                var xhr = new XMLHttpRequest();
                xhr.open("POST", '/api/session/set-timezone', true);
                xhr.setRequestHeader("Content-Type", "application/json");
                xhr.setRequestHeader("x-csrf-token", csrfToken);
                xhr.onreadystatechange = function () {
                    if (this.readyState === XMLHttpRequest.DONE && this.status === 200) {
                        localStorage['timezone'] = timezone.toString();
                    }
                };
                xhr.send(`{"timezone": ${timezone}}`);
            }
        } catch (e) { }
    }
}
```

